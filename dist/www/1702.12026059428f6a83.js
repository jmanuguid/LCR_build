"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[1702],{1702:(V,y,o)=>{o.r(y),o.d(y,{GenerateMunicipalFormNo103APageModule:()=>Q});var f=o(9808),c=o(2382),F=o(8058),N=o(5503),P=o(8398),m=o(7614),u=o(655),w=o(8675),U=o(8372),G=o(8505),C=o(7391),T=o(2340),e=o(4893),A=o(8876),Z=o(4465),S=o(7556),Y=o(4372),O=o(4263),h=o(8562);function B(n,l){1&n&&(e.ynx(0),e._uU(1,"Print preview"),e.BQk())}function L(n,l){1&n&&(e.TgZ(0,"span",26),e._uU(1,"Loading preview"),e.qZA())}function R(n,l){if(1&n&&e._UZ(0,"ngx-extended-pdf-viewer",27),2&n){const t=e.oxw(2);e.Q6J("src",t.pdfUrl)("useBrowserLocale",!0)("showToolbar",!1)}}function J(n,l){if(1&n){const t=e.EpF();e.ynx(0),e.TgZ(1,"div",13)(2,"aside",14)(3,"form",15)(4,"div",16)(5,"div",17)(6,"label",18),e._uU(7,"Verifier"),e.qZA(),e._UZ(8,"input",19),e.TgZ(9,"div",20),e._uU(10,"This field is required"),e.qZA()(),e.TgZ(11,"div",17)(12,"label",18),e._uU(13,"Remarks"),e.qZA(),e._UZ(14,"textarea",21),e.TgZ(15,"div",20),e._uU(16,"This field is required"),e.qZA()()(),e.TgZ(17,"button",22),e.NdJ("click",function(){e.CHM(t);const r=e.oxw();return e.KtG(r.printPreview())}),e.YNc(18,B,2,0,"ng-container",11),e.YNc(19,L,2,0,"ng-template",null,23,e.W1O),e.qZA()()(),e.TgZ(21,"aside",24),e.YNc(22,R,1,3,"ngx-extended-pdf-viewer",25),e.qZA()(),e.BQk()}if(2&n){const t=e.MAs(20),i=e.oxw();e.xp6(3),e.Q6J("formGroup",i.annotationForm),e.xp6(14),e.Q6J("disabled",i.loadingPreview||i.annotationForm.invalid),e.xp6(1),e.Q6J("ngIf",!i.loadingPreview)("ngIfElse",t),e.xp6(4),e.Q6J("ngIf",i.pdfUrl)}}function k(n,l){1&n&&e._uU(0,"Loading...")}const z=[{path:"",component:(()=>{class n{constructor(t,i,r,s,a,d,p,M,v,x,b){this.sqlService=t,this.toast=i,this.activatedRoute=r,this.authService=s,this.fb=a,this.deathReportService=d,this.pdfService=p,this.pdfViewerService=M,this.sql=v,this.router=x,this.datePipe=b,this.annotationForm=this.fb.group({verifier:this.fb.nonNullable.control("",{validators:c.kI.required}),remarks:this.fb.nonNullable.control("")}),this.loadingPreview=!1,this.skipLocationChange=T.N.production}ngOnInit(){return(0,u.mG)(this,void 0,void 0,function*(){yield this.initializeCurrentUser(),yield this.initializeRecord(),this.initializePreview()})}ngOnDestroy(){C.c.unsubscribe(this.annotationFormSubscription)}initializeCurrentUser(){return(0,u.mG)(this,void 0,void 0,function*(){try{const t=yield this.authService.getCurrentUserSnapshot();if(null===t)throw{code:"unauthenticated",message:"User is not currently logged in"};return this.currentUser=t,this.annotationForm.controls.verifier.setValue(t.firstName+" "+t.lastName),t}catch(t){return void console.error(t)}})}test(){return(0,u.mG)(this,void 0,void 0,function*(){const i=yield(yield this.pdfViewerService.getCurrentDocumentAsBlob()).arrayBuffer(),r=yield this.pdfService.reloadData(i);console.log({textFields:r});const s={};for(const a in r)if(Object.prototype.hasOwnProperty.call(r,a)){const d=r[a];if(void 0!==d)continue;s[a]=d}console.table(s)})}initializeRecord(){var t;return(0,u.mG)(this,void 0,void 0,function*(){try{const i=this.activatedRoute.snapshot.params.id,r=yield this.sqlService.table("death").row(i).get(),s=r.attachments.filter(a=>a);return this.record=Object.assign(Object.assign({},r),{attachments:s}),this.annotationForm.controls.remarks.setValue(null!==(t=r.remarks)&&void 0!==t?t:""),r}catch(i){return void this.toast.presentError(i)}})}initializePreview(){this.annotationFormSubscription=this.annotationForm.valueChanges.pipe((0,w.O)(this.annotationForm.value),(0,U.b)(500),(0,G.b)(t=>(0,u.mG)(this,void 0,void 0,function*(){var i,r;this.loadingPreview=!0;try{const s=null!==(i=this.record)&&void 0!==i?i:yield this.initializeRecord();if(!s)throw"internal";const a=null!==(r=this.currentUser)&&void 0!==r?r:yield this.initializeCurrentUser();if(!a)throw"internal";const d=Object.assign(Object.assign({},s),t),p=yield this.deathReportService.generateMunicipalFormNo103A(d,a);this.pdfUrl=p}catch(s){this.toast.presentError(s)}this.loadingPreview=!1}))).subscribe()}printPreview(){var t,i,r,s;return(0,u.mG)(this,void 0,void 0,function*(){try{const a=yield this.authService.getCurrentUserSnapshot();if(null===a)throw{code:"unauthenticated",message:"User is not currently logged in"};const d=this.annotationForm.getRawValue(),p=Object.assign(Object.assign({},this.record),{remarks:d.remarks}),v=yield(yield this.pdfViewerService.getCurrentDocumentAsBlob()).arrayBuffer(),x=yield this.pdfService.reloadData(v),b=yield this.deathReportService.generateCleanMunicipalFormNo103A(x,p),g=document.createElement("a");g.href=b,g.target="__blank",g.click(),g.remove();const E={datetime:this.datePipe.transform(new Date,"YYYY-MM-dd HH:mm:ss"),summary:`${a.username} generated Municipal Form No 103 A report for ${null!==(s=null!==(i=null===(t=this.record)||void 0===t?void 0:t.registrationNumber)&&void 0!==i?i:null===(r=this.record)||void 0===r?void 0:r.lastName)&&void 0!==s?s:"death"} record`,tags:["report",a.username],ipAddress:"",user:a.username};yield this.sql.table("audit").add(E)}catch(a){this.toast.presentError(a)}this.router.navigate(["../"],{relativeTo:this.activatedRoute,skipLocationChange:!0})})}}return n.\u0275fac=function(t){return new(t||n)(e.Y36(A.a),e.Y36(Z.k),e.Y36(m.gz),e.Y36(S.e),e.Y36(c.qu),e.Y36(Y.W),e.Y36(O.F),e.Y36(h.CG),e.Y36(A.a),e.Y36(m.F0),e.Y36(f.uU))},n.\u0275cmp=e.Xpm({type:n,selectors:[["app-generate-municipal-form-no-103-a"]],decls:17,vars:3,consts:[[1,"bg-light","border-bottom"],[1,"wrapper","px-xl-5","px-4"],[1,"d-flex","align-items-center","px-xl-5","pt-5"],[1,"mb-0","me-auto","text-dark","text-decoration-none","lh-1","fs-2-large","text-primary"],[1,"fs-2-large","text-primary","fw-bold"],[1,"px-xl-5","pt-3","pb-3","d-flex","justify-content-between","align-items-start"],["type","button","routerLink","../",1,"btn","btn-sm","btn-link","d-flex","align-items-center","text-decoration-none","text-info","ps-0",3,"skipLocationChange"],[1,"material-icons","fs-3","me-2"],[1,"fs-5"],[1,"content-wrapper","ps-xl-5","d-flex","flex-column"],[1,"ps-xl-5","ps-4","sd-section","flex-grow-1","d-flex","flex-column"],[4,"ngIf","ngIfElse"],["loadingState",""],[1,"row","m-0","flex-grow-1"],[1,"form-aside","col-3","p-0","pb-5","pe-4"],["novalidate","",1,"mt-5",3,"formGroup"],[1,"row","g-3","mb-5"],[1,"col-12"],[1,"d-block","text-truncate","form-label","fs-5","mb-1"],["type","text","formControlName","verifier","readonly","",1,"form-control","py-2","rounded-3"],[1,"invalid-feedback","mt-1","fs-5"],["type","text","formControlName","remarks",1,"form-control","py-2","rounded-3"],["type","submit",1,"rounded-3","px-4","py-2","btn","btn-info",3,"disabled","click"],["submitButtonLoadingState",""],[1,"iframe-aside","col-9"],["class","w-100 h-100",3,"src","useBrowserLocale","showToolbar",4,"ngIf"],[1,"loading-dots"],[1,"w-100","h-100",3,"src","useBrowserLocale","showToolbar"]],template:function(t,i){if(1&t&&(e.TgZ(0,"header",0)(1,"div",1)(2,"section",2)(3,"a",3)(4,"span",4),e._uU(5,"Generate Municipal Form No. 103 A"),e.qZA()()(),e.TgZ(6,"section",5)(7,"button",6)(8,"span",7),e._uU(9,"arrow_back"),e.qZA(),e.TgZ(10,"span",8),e._uU(11,"Back"),e.qZA()()()()(),e.TgZ(12,"main",9)(13,"main",10),e.YNc(14,J,23,5,"ng-container",11),e.qZA()(),e.YNc(15,k,1,0,"ng-template",null,12,e.W1O)),2&t){const r=e.MAs(16);e.xp6(7),e.Q6J("skipLocationChange",i.skipLocationChange),e.xp6(7),e.Q6J("ngIf",i.record)("ngIfElse",r)}},dependencies:[f.O5,c._Y,c.Fj,c.JJ,c.JL,c.sg,c.u,F.YI,m.rH,h.S3],styles:[".content-wrapper[_ngcontent-%COMP%]{min-height:calc(100vh - 132px)}.content-wrapper[_ngcontent-%COMP%] > main[_ngcontent-%COMP%]{height:100%}.iframe-aside[_ngcontent-%COMP%]{background-color:gray}"]}),n})()}];let j=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[m.Bz.forChild(z),m.Bz]}),n})();var I=o(9438);let Q=(()=>{class n{}return n.\u0275fac=function(t){return new(t||n)},n.\u0275mod=e.oAB({type:n}),n.\u0275inj=e.cJS({imports:[f.ez,c.u5,c.UX,F.Pc,j,N.D,P.q,I.xC,h.g3]}),n})()}}]);